<!DOCTYPE html>
<html lang="ko">
<head>
	<meta charset="UTF-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>카멘 격돌 연습</title>
	<style>
		html, body { padding: 0; margin: 0; background-color: grey; overflow: hidden; }
		.circle { position: absolute; top: 50%; left: 50%; width: 600px; height: 600px; }
		.circle > div { position: absolute; top: 0; left: 0; transform: translate(-50%, -50%); }
		.circle .inner {
			width: 300px;
			height: 300px;
			border: 18px solid #7fffff;
			border-radius: 50%;
		}
		.circle .outer {
			border: 6px solid #59e4ff;
			border-radius: 50%;
			width: 600px; height: 600px;
		}
		.circle.bad .outer {
			border-color: red;
		}
		.circle.perfect .outer {
			border-color: #e3b274;
		}
		.circle.perfect:before {
			display: block;
			content: "";
			position: absolute; top: 0; left: 0; transform: translate(-50%, -50%);
			border: 10px solid #e3b274;
			border-radius: 50%;
			width: 300px; height: 300px;
			animation: fadeOutScale 0.5s;
		}

		.circle .key {
			background-color: #f4e7c6;
			color: #7d5a1c;
			font-weight: bold;
			border-radius: 10px;
			width: 60px;
			height: 60px;
			display: flex;
			justify-content: center;
    		align-items: center;
			font-size: 34px;
		}
		.circle.bad .result {
			text-shadow: 0px 0px 5px red,0px 0px 10px red,0px 0px 15px red;
		}
		.circle.perfect .result {
			text-shadow: 0px 0px 5px rgba(125, 90, 28, 1),0px 0px 10px rgba(125, 90, 28, 1),0px 0px 15px rgba(125, 90, 28, 1);
		}
		.circle .result {
			color: white;
			top: 170px;
			transform: translate(-50%, -50%);
			font-weight: bold;
			display: flex;
			justify-content: center;
    		align-items: center;
			font-size: 54px;
		}

		#score {
			font-size: 24px;
			font-weight: bold;
			padding: 20px;
		}
		@keyframes fadeOutScale {
			from {
				opacity: 1;
				width: 300px;
				height: 300px;
			}

			to {
				opacity: 0;
				width: 500px;
				height: 500px;
			}
		}
	</style>
</head>
<body>
	<script>
		function getRandomInt(min, max) {
			min = Math.ceil(min);
			max = Math.floor(max);
			return Math.floor(Math.random() * (max - min + 1)) + min;
		}

		function calculateDistance(x1, y1, x2, y2) {
			const deltaX = x2 - x1;
			const deltaY = y2 - y1;
			return Math.sqrt(deltaX * deltaX + deltaY * deltaY);
		}

		class Circle {
			constructor(x, y) {
				this.play = true;
				this.size = 600;
				this.currentSize;
				this.duration = 1500;
				this.progress;

				this.top = y;
				this.left = x;

				this.wrapper = document.createElement("div");
				this.wrapper.classList.add("circle");
				this.inner = document.createElement("div");
				this.inner.classList.add("inner");
				this.outer = document.createElement("div");
				this.outer.classList.add("outer");
				this.key_wrapper = document.createElement("div");
				this.key_wrapper.classList.add("key");
				this.wrapper.append(this.inner, this.outer, this.key_wrapper);
				this.wrapper.style.top = this.top + "px";
				this.wrapper.style.left = this.left + "px";
				document.body.append(this.wrapper);

				const keys = ['Q', 'W', 'E', 'R', 'A', 'S', 'D', 'F'];
				this.key = keys[getRandomInt(0, keys.length - 1)];
				this.key_wrapper.textContent = this.key;

				this.animate();
			}

			catch() {
				if (!this.play) return;

				if (this.currentSize <= 350 && this.currentSize >= 280) {
					this.end("perfect");
				} else {
					this.end("bad");
				}
			}

			end(result = "bad") {
				if (!this.play) return;
				this.play = false;
				clearTimeout(this.failTimer);

				for (const ci in helper.circles) {
					if (helper.circles[ci] == this) helper.circles.splice(ci, 1);
				}

				this.result = document.createElement("div");
				this.result.classList.add("result");
				this.wrapper.append(this.result);

				if (result == "perfect") {
					this.wrapper.classList.add("perfect");
					this.result.textContent = "Perfect";
					helper.up_perfect();
				} else {
					this.wrapper.classList.add("bad");
					this.result.textContent = "Bad";
					helper.up_bad();
				}
				setTimeout(() => {
					this.wrapper.style.transition = "opacity 0.5s";
					this.wrapper.style.opacity = "0";
				}, 500);
				setTimeout(() => {
					this.wrapper.remove();
				}, 1000);
			}

			shrink(timestamp) {
				if (!this.play) return;
				if (!this.startTimestamp) this.startTimestamp = timestamp;
				this.progress = (timestamp - this.startTimestamp) / this.duration;
    			this.currentSize = this.size - (this.size * Math.min(this.progress, 1));
				this.outer.style.width = this.currentSize + "px";
				this.outer.style.height = this.currentSize + "px";
				if (this.progress < 1) {
					this.animationId = requestAnimationFrame((timestamp) => this.shrink(timestamp));
			    }
			}
			animate() {
				this.animationId = requestAnimationFrame((timestamp) => this.shrink(timestamp));
			}
		}
		

		class CrashHelper {
			constructor() {
				this.score_perfect = 0;
				this.score_bad = 0;

				this.$score = document.createElement("div");
				this.$score.setAttribute("id", "score");

				this.$score_perfect_wrapper = document.createElement("div");
				this.$score_perfect = document.createElement("span");
				this.$score_perfect_wrapper.append("Perfect: ", this.$score_perfect);
				this.$score_perfect.textContent = 0;
				this.$score_bad_wrapper = document.createElement("div");
				this.$score_bad = document.createElement("span");
				this.$score_bad_wrapper.append("Bad: ", this.$score_bad);
				this.$score_bad.textContent = 0;

				this.$score.append(this.$score_perfect_wrapper, this.$score_bad_wrapper);

				document.body.append(this.$score);

				this.circles = [];

				setTimeout(() => {
					this.next();
					setInterval(() => {
						this.next();
					}, 5800);
				}, 1000);
				this.setKeydown();
			}

			next() {
				this.newCircle();
				if (getRandomInt(0, 2) == 0) {
					setTimeout(() => {
						this.newCircle();
					}, 250);
				}
				// setTimeout(() => { this.next(); }, 5800);
			}

			newCircle() {

				let x = getRandomInt(600, window.innerWidth - 600);
				let y = getRandomInt(600, window.innerHeight - 600);
				const prevCircle = this.circles[0];
				if (prevCircle) {
					while (calculateDistance(x, y, prevCircle.left, prevCircle.top) < 500) {
						x = getRandomInt(600, window.innerWidth - 600);
						y = getRandomInt(600, window.innerHeight - 600);
					}
				}
				const circle = new Circle(x, y);
				this.circles.push(circle);
				circle.failTimer = setTimeout(() => {
					circle.end("bad");
				}, circle.duration);
			}

			setKeydown() {
				const keys = ['Q', 'W', 'E', 'R', 'A', 'S', 'D', 'F'];
				document.addEventListener('keydown', (event) => {
					if (!this.circles.length) return;
					const pressedKey = event.key.toUpperCase();
					const nextCircle = this.circles[0];
					if (keys.includes(pressedKey)) {
						if (nextCircle.key == pressedKey) nextCircle.catch();
						else nextCircle.end("bad");
					}
				});
			}

			up_perfect() {
				this.score_perfect++;
				this.$score_perfect.textContent = this.score_perfect;
			}

			up_bad() {
				this.score_bad++;
				this.$score_bad.textContent = this.score_bad;
			}
		}

		const helper = new CrashHelper();
	</script>
</body>
</html>
